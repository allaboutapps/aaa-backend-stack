# Deployment README

## Deployment to server

In this example we add a 'dev' server:

1. Create the VM / server with networking setup
2. Add a host file `ansible/environments/dev`
3. Add a group_vars file `ansible/group_vars/dev.yaml`
4. Modify `ansible/files/service-dev.env.j2` to your needs
5. Provision the server: `ansible-playbook -i environments/dev provision.yaml`
6. Get the ssh-key for the server user (in this case 'node'):
```
local$ ssh -tt USERNAME@YOURAPPHOST.allaboutapps.at "sudo cat /home/node/.ssh/id_rsa.pub"
```
1. Add the public key to the Git repository with read permissions (Settings -> Access Keys)
2. Commit all changes in the Git reporitory, and push to origin
3. Create a new git tag with `git tag v0.1.0` and push it to the server with `git push origin --tags`
4. Deploy the app: `ansible-playbook -i environments/dev deploy.yaml`
5. Setup iptables to open the port 8080
```bash
local$ ssh -l USERNAME yourprojecturl.allaboutapps.at
host$ sudo su
host$ iptables-save  # prints the current rules
host$ iptables -A INPUT -s 192.168.64.0/19 -i eth0 -p tcp -m tcp --dport 8080 -j ACCEPT
host$ iptables-save  # prints the current rules
# # Generated by iptables-save v1.4.21 on Thu Feb 25 16:17:59 2016
# *filter
# :INPUT DROP [0:0]
# :FORWARD ACCEPT [0:0]
# :OUTPUT ACCEPT [27:3152]
# -A INPUT -i lo -j ACCEPT
# -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# -A INPUT -s 192.168.64.0/19 -i eth0 -p icmp -j ACCEPT
# -A INPUT -s 192.168.64.0/19 -i eth0 -p tcp -m tcp --dport 22 -j ACCEPT
# -A INPUT -s 192.168.64.0/19 -i eth0 -p tcp -m tcp --dport 8080 -j ACCEPT
# COMMIT
# # Completed on Thu Feb 25 16:17:59 2016
host$ iptables-save > /etc/sysconfig/iptables  # permanently saves the rules
```

## Deploying production servers

### Setting a new application root admin password

By default, all created admins have the same simple password, as specified in their migration `XXX-insert-administration-user.ts`. If you deploy *production* or *staging* applications which are exposed to the public, ensure to change this!

```

host$ sudo su node
# set-user-password without an -u flag defaults to the root admin user
host$ yarn db set-user-password -p NEW_PASS

```

As always, ensure to document this new password in a shared password manager.

